create type difficulty_level as enum ('beginner', 'intermediate', 'advanced');
drop table courses;
create table courses (
	course_id serial primary key,
	title text not null,
	description text,
	duration_weeks int,
	difficulty_level difficulty_level not null default 'beginner',
	price decimal(10, 2) check (price >= 0),
	complexity_level int check (complexity_level between 1 and 5) default 1,
	is_active bool default true,
	created_at timestamp default current_timestamp,
	updated_at timestamp default current_timestamp
);

create table modules (
	module_id serial primary key,
	course_id int not null,
	title text not null,
	description text,
	module_order int not null check (module_order > 0),
	created_at timestamp default current_timestamp,
	foreign key (course_id) references courses(course_id) on delete cascade,
	unique(course_id, module_order)
);

create type lesson_type as enum ('lecture', 'seminar', 'practice', 'consultation', 'test');

create table lessons (
	lesson_id serial primary key,
	module_id int not null,
	title text not null,
	content text,
	lesson_type lesson_type not null default 'lecture',
	duration_minutes int not null check (duration_minutes > 0),
	lesson_order int not null check (lesson_order > 0),
	has_homework bool default false,
	is_required bool default true,
	max_score integer check (max_score between 0 and 100) default 100,
	created_at timestamp default current_timestamp,
	foreign key (module_id) references modules(module_id) on delete cascade,
	unique(module_id, lesson_order)
);

create type user_status as enum ('active', 'inactive', 'suspended', 'graduated');

create table students (
	student_id serial primary key,
	first_name text not null,
	last_name text not null,
	email text unique not null,
	phone text,
	registration_date timestamp default current_timestamp,
	date_of_birth date,
	status user_status default 'active'
);

create table reviewers (
	reviewer_id serial primary key,
	first_name text not null,
	last_name text not null,
	email text unique not null,
	phone text,
	hire_date date check (hire_date <= current_date),
	specialization text,
	status user_status default 'active'
);

create type enrollment_status as enum ('active', 'completed', 'cancelled', 'paused', 'waiting_payment');

create table enrollments (
	enrollment_id serial primary key,
	student_id int not null,
	course_id int not null,
	enrollment_date timestamp default current_timestamp,
	completion_date timestamp,
	status enrollment_status default 'active',
	overall_score int check (overall_score between 0 and 100),
	foreign key (student_id) references students(student_id) on delete cascade,
	foreign key (course_id) references courses(course_id) on delete cascade,
	check (completion_date is null or completion_date >= enrollment_date)
);

create table lesson_completions (
	completion_id serial primary key,
	enrollment_id int not null,
	lesson_id int not null,
	completed_at timestamp default current_timestamp,
	score int check (score between 0 and 100),
	foreign key (enrollment_id) references enrollments(enrollment_id) on delete cascade,
	foreign key (lesson_id) references lessons(lesson_id) on delete cascade,
	unique(enrollment_id, lesson_id)
);

create table homeworks (
	homework_id serial primary key,
	lesson_id int not null,
	title text not null,
	description text,
	max_score int check (max_score between 1 and 100) default 100,
	deadline_days int check (deadline_days >= 0),
	is_optional bool default false,
	created_at timestamp default current_timestamp,
	foreign key (lesson_id) references lessons(lesson_id) on delete cascade
);

create type homework_status as enum ('submitted', 'under_review', 'approved', 'rejected', 'needs_revision', 'resubmitted');

create type urgency_level as enum ('low', 'normal', 'high', 'critical');

create table homework_submissions (
	submission_id serial primary key,
	homework_id int not null,
	enrollment_id int not null,
	reviewer_id int,
	submission_text text,
	submitted_at timestamp default current_timestamp,
	score int check (score between 0 and 100),
	feedback text,
	reviewed_at timestamp,
	status homework_status default 'submitted',
	urgency urgency_level default 'normal',
	foreign key (homework_id) references homeworks(homework_id) on delete cascade,
	foreign key (enrollment_id) references reviewers(reviewer_id) on delete set null,
	check (reviewed_at is null or reviewed_at >= submitted_at)
);

create table certificates (
	certificate_id serial primary key,
	enrollment_id int not null,
	certificate_url text,
	issue_date timestamp default current_timestamp,
	expiration_date timestamp,
	verification_code text unique,
	grade_level difficulty_level,
	foreign key (enrollment_id) references enrollments(enrollment_id) on delete cascade,
	unique(enrollment_id),
	check (expiration_date is null or expiration_date > issue_date)
);

create type requirement_type as enum ('mandatory', 'recommended', 'optional');

create table course_prerequisites (
	prerequisite_id serial primary key,
	course_id int not null,
	required_course_id int not null,
	min_score int default 0 check (min_score between 0 and 100),
	requirement_type requirement_type default 'mandatory',
	created_at timestamp default current_timestamp,
	foreign key (course_id) references courses(course_id) on delete cascade,
	foreign key (required_course_id) references courses(course_id) on delete cascade,
	check (course_id != required_course_id),
	unique(course_id, required_course_id)
);

create type deadline_type as enum ('course_start', 'course_completion', 'module_completion', 'lesson_completion', 'homework_submission');

create type deadline_status as enum ('active', 'missed', 'completed', 'extended', 'cancelled');

create table deadlines (
	deadline_id serial primary key,
	enrollment_id int not null,
	deadline_type deadline_type not null,
	target_id int not null,
	deadline_date timestamp not null,
	status deadline_status default 'active',
	urgency urgency_level default 'normal',
	completed_at timestamp,
	created_at timestamp default current_timestamp,
	foreign key (enrollment_id) references enrollments(enrollment_id) on delete cascade
);